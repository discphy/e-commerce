# E-커머스 서비스 시퀀스 다이어그램

**📚 문서 목록**

+ [1️⃣ 요구사항 분석 문서](01.Requirements.md)
+ [2️⃣ 마일스톤 문서](02.Milestones.md)
+ [3️⃣ 시퀀스 다이어그램 문서](03.SequenceDiagram.md)
+ [4️⃣ ERD 문서](04.ERD.md)
+ [5️⃣ API 명세](05.ApiDocument.md)

---

<!-- TOC -->
* [E-커머스 서비스 시퀀스 다이어그램](#e-커머스-서비스-시퀀스-다이어그램)
  * [잔액 충전](#잔액-충전)
  * [쿠폰 발급](#쿠폰-발급)
  * [주문 및 결제](#주문-및-결제)
  * [상위 상품 배치 스케줄러](#상위-상품-배치-스케줄러)
<!-- TOC -->

> 주요 로직에 대한 시퀀스 다이어그램 작성을 하였습니다. (단순 조회 기능의 경우 생략하였습니다.) 

## 잔액 충전

```mermaid
sequenceDiagram
    autonumber
    actor 클라이언트
    participant 잔고
    클라이언트 ->>+ 잔고: 잔액 충전 요청
    잔고 ->>+ 잔고: 잔고 조회

    opt 잔고 없을 시
        잔고 ->>+ 잔고: 잔고 생성
    end

    잔고 ->>+ 잔고: 잔액 충전

    opt 최대 잔고 초과 ❌
        잔고 -->>- 클라이언트: 최대 잔고 초과 예외 ⚡️
    end

    잔고 ->>+ 잔고: 잔액 저장
    잔고 -->>- 클라이언트: 잔액 충전 성공 ✅ 
```

## 쿠폰 발급

```mermaid
sequenceDiagram
    autonumber
    actor 클라이언트
    participant 쿠폰
    participant 사용자쿠폰
    클라이언트 ->>+ 쿠폰: 쿠폰 발급 요청
    쿠폰 ->>+ 쿠폰: 쿠폰 조회

    opt 쿠폰 발급 수량 부족 ❌
        쿠폰 -->>- 클라이언트: 쿠폰 발급 수량 부족 예외 ⚡️
    end

    쿠폰 ->>+ 쿠폰: 쿠폰 발급
    쿠폰 ->>+ 사용자쿠폰: 쿠폰 저장
    사용자쿠폰 -->>- 쿠폰: 쿠폰 저장 완료
    쿠폰 -->>- 클라이언트: 쿠폰 발급 성공 ✅ 
```

## 주문 및 결제

```mermaid
sequenceDiagram
    autonumber
    actor 클라이언트
    participant 주문
    participant 상품
    participant 쿠폰 AS 사용자쿠폰
    participant 잔고
    participant 주문상품
    participant 외부 데이터플랫폼
    클라이언트 ->>+ 주문: 주문/결제 요청
    주문 ->>+ 상품: 상품 조회

    opt 상품 재고 부족 ❌
        상품 -->>- 주문: 상품 재고 부족
        주문 -->> 클라이언트: 상품 재고 예외 ⚡️
    end

    주문 ->> 주문: 상품 가격 계산
    Note over 주문, 쿠폰: 쿠폰 사용 시
    주문 ->>+ 쿠폰: 쿠폰 조회

    opt 만료 쿠폰 or 사용된 쿠폰 ❌
        쿠폰 -->>- 주문: 만료 쿠폰 or 사용된 쿠폰의 경우
        주문 -->> 클라이언트: 쿠폰 유효성 예외 ⚡️
    end

    주문 ->> 주문: 주문 금액 계산 (쿠폰 사용 시, 할인포함)
    주문 ->>+ 잔고: 잔고 조회

    opt 잔고 부족 ❌
        잔고 -->>- 주문: 잔고 부족
        주문 -->> 클라이언트: 잔고 부족 예외 ⚡️
    end

    주문 ->>+ 상품: 상품 재고 차감
    상품 -->>- 주문: 상품 재고 차감 완료
    주문 ->>+ 잔고: 잔고 차감
    잔고 -->>- 주문: 잔고 차감 완료
    Note over 주문, 쿠폰: 쿠폰 사용 시
    주문 ->>+ 쿠폰: 쿠폰 사용
    쿠폰 -->>- 주문: 쿠폰 사용 완료
    주문 ->> 주문: 주문 생성
    주문 ->>+ 주문상품: 주문 상품 저장
    주문상품 -->>- 주문: 주문 상품 저장 완료
    주문 ->>+ 외부 데이터플랫폼: 주문 정보 전송
    외부 데이터플랫폼 -->>- 주문: 주문 정보 전송 완료
    주문 -->>- 클라이언트: 주문/결제 성공 ✅ 
```

## 상위 상품 배치 스케줄러

```mermaid
sequenceDiagram
    autonumber
    participant 스케줄러 AS Scheduler
    participant 주문상품
    participant 주문상품통계

    loop 배치 폴링 🔁
        스케줄러 -->>+ 스케줄러: 배치 시간 확인

        opt 배치 시간 ⏱️
            스케줄러 ->>+ 주문상품: 배치 시작
            주문상품 ->>+ 주문상품: 하루 전, 주문 완료된 상품 조회 및 집계
            주문상품 ->>+ 주문상품통계: 집계 데이터 저장
            주문상품통계 -->>- 주문상품: 집계 데이터 저장 완료
            주문상품 -->>- 스케줄러: 배치 완료
        end

    end
```







